var patrimonio_icono =
  "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAV8AAADDCAYAAAAlZhINAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo4QUI5QzEzNzc1RDAxMUU5ODhFNUYwOTQyODYxNTNDQiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo4QUI5QzEzODc1RDAxMUU5ODhFNUYwOTQyODYxNTNDQiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjhBQjlDMTM1NzVEMDExRTk4OEU1RjA5NDI4NjE1M0NCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjhBQjlDMTM2NzVEMDExRTk4OEU1RjA5NDI4NjE1M0NCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+QFWUrAAAK6tJREFUeNrsfQl0HcWZ7t930b5Zkq3FulpseddqzGI77CHJDEPCEhINZIiJh9jjAC+PxcSxx4AxYDCTk2Q4ecNjSMi8kBnyIDwGwjCACQFs8CpZtmV5k2Rrt6Sr9e63b7+/pMbYspa79FLVXd85pdaR7u2u+qv666+r6quyAAcT8HzrX/43pmQeCY6JIL2UmYzpRR4JRupLksDCw8AE8V6Nh3swPcCjwTEJSNv4eyTga3go2IDAQ0A98ZI62oNpGaYRTKWJb67t5pHhOE/1zsLDKUwpmPZhukxY7ZR4ZLjy5YgN35GJF+SbazMPCcc4bJbbBshtpYaHhCtfjthUbxweGjGVnPdnEdNiVL/HeYQ4UPXOw0MDJtt5f27GtBDVr59HiCtfjuiwbhzxElgxPc1DwyFj2zjiBbnNrOOh4cqXIzrVm4GHk5iyJvnISlS/u3ikTK16V+Bh5yT/dmKai+p3gEeKK1+OyLBhCuIleJaHyPSYqg1kym2Ig1Jw8qVT9TrwcP80H1uJn7uFR8u0qvdm0gam+dj9+DkHjxYnX47wsRVTQhif24YEbOPhMh3xkjrfFsZHSRt6kkeMky9HeKq3Eg9/F+bH58OY+YLDXFiNaUGYn/0eknUlDxknX47pQfrxIhkIfRQJO4WHzTSql9T14xF8hbSl7TxynHw5pla9X8XD1yL8Wg6mh3j0TIOH5DqPBDcgad/AQ0cX+FQzeoiXPAgPYIrmFdEFY7bjLh5JQ6veXBibfhjNAksHMS0VVjtDPJIU1CWfakYV7oySeEG+GR/jITQ8Ho2SeEFuW3fyEHLly3Gh6k2EMRtxYQynIbbjMlS/jTyihlS9ZIDtCIw5HKNFK6YFqH49PKJc+XKM4d4YiRfkm3IbD6VhsS1G4iVwyG2NgytfDlS9xInUhCldoVNeier3Ux5ZQ6ner+DhE4VONwhjtuM+HlmufM2OTQoSL8Gz8hrAHMYgXlKXSlrJSVvbyCOrPzj56qt6S1R4DVyO6VYeXcPgVrlOlcS9SOolPLScfM0MYv20q3Dep5HY7Ty8zKteYiNWY/lQ0jae4hHm5GtW1Ut2HPhblU5PFthew6PMPNbIdakGapDcl/EQc/I1I9ReEnIzEnwqDzOzqpfU3WbG2yAHJ1/qVO+NeLhW5cvMxLSeR5tZkLqbpfI1rkWS/xsean3AR8W1J14yV5NYPZdocDk3jNmOO3nkmVK9eTBmI07S4HLEuFEprHaKPPIa1jGfaqYLVmlEvCDfvFt4yJnDFo2IF+S2uIqHnCtfo6teckOdwJSv4WWJoqlA9dvAa4AJ1bsID4cgdjdbJCBvRqWoft28BrjyNSoe0Jh4Qb6Jn+GhZwbPaEy8BHly2+TgyteQqpcMgJ3CpNcMhKtR/X7Ma4Jq1XslHvSqo2FZ/Z7lNcGVr9HwqI7ES/Actx1TTbykbv5JxyxoMbWN4zxw8tVG9dJgergU07d5bVCLb8t1pCfW4ENgHq8KTr5GArGI0rDLMLEdx/HqoE71xoE6NuJIYaMkH5x8ORRRvSvwcBsl2ZmLaS2vFeqwRq4bGnAbPgxW8Crh5GsE0GbhJLbjdF4t1KjeNKCvr5Xbjjn5Mq96b8HDSsqylQXcdkwTSF1kU5anlfhQuIVXjbrgo9/qES/pPyPWzfkUZs8LY7bjdl5Tuqre2TBmI06gMHvHMS0RVjuDvKZUqHs+1UxV3EMp8YJ8s3Pbsf7YQinxgtx27+FVxJUva6o3RVY0ORRnM4SpEtXvYV5juqjeMhhbYIlmAUQMF2S/txFeY1z5soL1lBMvyDc9tx3rh21A/5jLLODjA1z5MqR6iU+eLJ6TzEiWr0f1+yGvOU1V7zV4+DMj2XVhmofqly9LypUv9XicIeIl4Lsda0u8JNbPMZTlZLlNc6jw6smhnOolywH+gLFsX4KphteeZqiRY84SfiAvdcnByZda6LEcoBJ4ktuONVG9JMZPMph1viwpJ1+qVe9VeLiJ0eyXYFrHa1F1rJNjzSJuwofHVbwKlQPv61OGeEkcd4P+q1LFAiemuYlvrh3gNaqK6s2AsemHWQwXYy+my4XVTonXaIztgQ+4KYbbGSdegkxMG3hVqoZHGCdekNv47bwqufKlRfWSfryjmOYYoDjEdjwf1W8rr1lFVa8Dxuy6CQYoThOmRah+/bxmufLVG2sNQrwgk8MTvEoVxxMGIV6Q2zpflpQrX91VL1ma8ZQBXicveChjqkL1W89rWBHVW4GHOoPda30wZjse5DXMla9e+InBiPeLBzKfVqQcnjGgyMmS2z4HV766qN4CGLMRJxi0iDeg+v2A13RMqvd6PBg1hmR8gNiO23hNc+WrNYzUjzcRiO2Yt4/oiZcIGyPvCMHHB2IEv7miU72kH+/7Bi9mNaY7eG1HjTsxLTV4Gb8v92lzcPLVDEbsx5sIW/FBE8+rO2LVS2K21QRF5eMDnHw1Vb1fxcM3TFLcIkz38lqPGPfKsTMDvoEPm6/yKo/uycURPvGSh9U++ZXcLOjHNIfbjsNWvcRGTIwIM0xU7FpMy4TVzhBvAWG2Ez7gFjHuMBnxgkwim3jVh42NJiNeAD4+wJWvyqqXjO4ew1RowuL7MC1A9Xuat4QpVS/pamgEY8+CmQykbSxE9evlLYErX6Vxr0mJl8AsA0ixYqtJiZeAjw9w5auK6iUrfhEbcYaZH9aYlqL6reMtYkLVW4WHAya/p8i4wBxUv/28RXDlqxQ2mpx4v3hQb+dNYVJs52Jm9B7h4wNc+SqmeothrK+Xb7Mzhq+h+n2fh+EC1XsDHt7jkRgFWWpyAarfFh4KrnxjxVZOvBfgOW47voB4LfyN4ALEAR8fCAv8Jppa9ZJdZu/kkbgAxE76PR6GcyDto5KH4cKY4EPpEh4GTr6x4FkegonfBvDBlMhVbyaJwZO8OfB7h5Ovsqr3r/FwHY/EhCDb4vBpRWMxcPAwTIjr8OH0VzwMk4MPuE1MvOShdBBTGY/GpCC7GBDbsdOkqpdMPyQ24nTeFCbFYUyV3HY8QfvhA26TYhUn3mlBSGejicu/kRPvtCiT7yUOrnzDUr2kH+8kpnwejWkRgDHbcbPJVG8x8OmH4aIdxna88PBQcOU7JfD96AFOvGHD7rbbzDetyCLy6YfhYzaICQ/wMEzQjHgIvsTO776Y3RRn5aszRYC7rr18IfxH61KzlFc6AEth3uBCXvPhI9h4wx2uVY9k80hw8p0Km4cssNgnCHzb9DBwLDuj+09ZGWQ5QTNNK9oOSUjASa4u3gLCgGdWvd+Zu5jcWzwYnHwnU72leFhLfm+OE0i3g8ijMjWuX7G0D8bGDa5H9ft1E6heMnXqutEyl/icvAVMC9HXcM0XXXhrUf3O5SHh5DsRnsZkJ7+4BSF7xCLw1bumelg5cpv7khMXn/enZ5GADduekHhJ2b7crywOFkOGs4m3hCkwVFInutO/6G4g99ZTPCicfMer3svw8O3z/9Zsty4iL008OhMQkSDAVy+7yFFLbMd3GbjYpGzlF/ylkLeFqTocvEdXLhr3t++g+r2Mh4aT7/l4bvwfAoKU5LQKR3hoLsbrC0saIM5WMsG/nkD1azjbMarexNGyjYcV5sAsJ28jE6Gn7EjIn5gUzr3Gyde8qvcmPFw50f/O2C1kMIn37Z0Hv9Uq/V3FwqxJ/l2A6X4DFvt+uWwXIx+y8S6SeMs4/2lldXpOLJtsr8MrUf3exINkcvJF4rXhYdtk/w+htumyWVp5M/kSv6peVAcWIWeKj2xA9ZtlINWbPVqmySBADuQ7+fjA+Wi7rFUS7dYpPrENCdjGydfcuBvT4qk+0GkTKlHWcAJGDMXH+TaUFpZO8zFiuTXSbgabYDob8UwoBVvQx1sIUSzxbe7Ti6dbYpPcc6s4+ZpX9SbjYcu0yme0+0Fw87sKYPPlFUdAEFLD+OiPUP3OMYDqJWVYF8ZHU6Fw6DBvIQDiqatcIIVFK1tQ/SZx8jUniOUxN5wP9lktC4LCqJfftOhMTR58YXZOeZgfJ9OKjLDO7ZNyWaZHOlRAvGfQ1MwbSDvm6ypeEOan8zA9yMnXfKp3Fh7WR/KdZrvV1E/pe1ZUN4dNRGOoQfW7jGHVu2y0DOHDDiWeZjO3kcCxayK9R9aj+p3Fyddkb9CYUiL5wrAFHF6T2o4bZ87o3JGZXhXFV1m2HUee90SogpTBTlPeUZ7c+kB/TqQLy6eAiW3HpiNfVL3z8LAmmu82xQmzwYS24+oVSwei/Oq1qH5vZFD1/s1o3qNBsdhvQh4RfQ1Xz47yu2tQ/c7j5GsOkKllUU1zQeWbNWwy2/FfivJPQVLCohhO8QwSsJUh4rXCFNMPw+h8WAyZzlOmuqMG5taJ7rRopxeSe/FpTr7GV70r8HBrLOdoGbMdm2L2Q0gQ4BuXlsdKnEuArWlFq+Q8Rw8HErh5tilwe4+tWBTjOW5D9XsFJ19jI+Y+SGI77rMKR80QrD8smnsY7LZiBU61hQXbsWwj3qLAXVUMs5yHTHFHna08GvInKDEYbTrbsWnIF1XvzXhYqcS5Wu2WKgmgz8jx8lmt0t3l83MUOh1ZVpCF3QyU28UkD3INbzuWrH2ek0urFDrbSlS/N3PyNR7xTmkjjvh1fMx23G7kmP3iksW1YBFmKnjK9ah+Z9JaXlS9MyHC6YdTQsDzzXbWGvrGar28XRJtSvbnm8p2bBbluxrTAiVP2GUTKkIGtR0Pxsf7Hp1bOF/h06YB3dOKNst5VA7ZMN+wtuNQ/Bn3mUUVCp91gXyvcvI1iOolcwkfV1wpjXY/GNN2vHF5JbHKpqhw6jWofktpKy+q3lKIcvrhNEiBImPajkMnr/aGaSOOFI+h+k0BE8AMyvchTDlqnJjYjgMCNBopWB1pyQMv5c2sUOn0xCFH47Sic7uYKI60UdvxgKHuqEB6o7e7aL5KZyeWf1Psdmxo8kXVmyuTr2posVsN9ZT+/spLTqtGRGP4NqpfanYzQNV70S4mij9w5nhaDMW9jdeo3eaJ7TgXDA6jK99HMSWreYFhCxR4BeGgEYJ1eFZW+6cZqZUaXIqmaUXq5yWB2I4HjDFA6849GBiYVaDyVZLle5eTL6Oql3Te36PFtZriBOJpZ952fOmK6mGNLnUlqt9vUqB6J93FRHEUh4YNcFuJvqNXOzS61j2ofheAgWFk5Uv68TSxtaLyzRy2CExPK/pzyewTkBi/UMNLEtuxbtOKkHjJtbVb+McOCyHTeYLpO2qgtFZ0p2VqdDUrGNx2bEjyRdX7FTzcouU1W+xWYkl1sRgvYiP+60vK4zW+LCH6u3Us9t1yHrSDA+IZth27vI3LyzS+5i2ofleCQWE48kXiFUCHpQwDgpTYZ7UwueD6K0tKD4HdqsdG6MR2nKz1RVH1hrWLiQp3WyHkONlclrSr6lgokJCgw5VZXpbUdMqXLJyzXI8Lt9pH93vrZSlYHptN/GHZvDydLq/XtKKwdzFRocT5YBHZGh+QrL2epupKna6+AtXvbZx86Ve9ui5PR2zHnTZLB0sx+8Uliw+CIGTrmIVHUP3maHUxVL0R72KiKATIhoJBtpYlPXNFh8I24kjxtBFtx0ZTvsSlpOvCzN1jtuMzLARrICHe8/gcx0Kds0G6ALS0HUe8i4niyIJFYA94mLijxIQz7taFFTrnIuoNEDj5aqN6qdiSZGy3YysTfv71y6sa8EDD3nTEdjxf9bo5AOQaaykobxIUDR9hgntPXu1XyUYc8UPTaLZjIynfRzBRsRmf0wrzAgJQveZvW3qq8//kZldRkh2tphVpNv1wWqRCNSS4nVTfUf6MRt/ZQlrW4tC3u4iT76SqlwwYUeUHb7Zb02iO2R0rq1upIaIx3Irqd4WKqjfmXUwUf+CUeKleFS9w9LpUyrL0AKrfPDAIjKJ8t1Dy+nwOIxaY7RXo3O+tPie7bW96aiWFWduu4rnpm7KUAJWQ1t9G5R3lzqsLDGXNpixXZHzgcTAImCdfVL1k/6i7aczbqTihmAgImvJE+qQvX1FFqxlkBapfxdUpql7FdjFRHEUSjXUR8DdcXUxpG/kBqt9FYAAYQfk+Q9nr8zn4BCFjyELXojvvzXUch4R4mj3zTytpO5ZtxNuoLa0NFkC2ky5zTv+8+qAnNYPSiFnle56Tr86qlyyKchPNeTxtt5aTXgga8kJsxDdfsiSJ8molMxKUXBCJnIvuBVpm4+s0NbZj64j3mOY24khxE6rfK4FxMEu+so2Y+h1PA4IU3yEIVCib35bPrwertYCB6n0U1W/M04pQ9aYAC0sTWqAAcp10vCGdrjgWCsTHM9BGtiMBs7tSBuPKlyyAfRkLGX2l3RXX6Q/16JkHYiNet3jubEbqljjelJhWpNouJiqUuEB323H7jJ7+FxLsjLSRyzExbTtmknxR9cYBI8vNnXUFTw/7xPJXz3q69MzHs5eW1YEgZDFUzQ+g+o16WhGqXtV3MVEUAmSBQ1/b8dC/OrpDA96KUPdgCyNRI7bjOE6+2oJYDeeykNF9Ha7R2Q7OQKj8hDuoS6PuT0pwbyuevZixOibTih6LqetC5V1MFEcmLAZ7QJ9NWRtyWwLd1tG+Xv/OliAjEVNr41NOvpOoXtq3ID+H5n5/oz8onXMIvdbr1aVR/8/l1WSTz0QG2+dqVL8Rrz2BqlezXUwURiIUD2u/IaskQP9vcs51eUi+QGmoqYeVjWGJ7TiNwbpmUvmSvsBs2jMZwgZ9+KzngkbhEaXSvcMBTW3HpzNSe1+dlVkJbCLaaUXUTj+cFilQCQluTZcllT51NIRclgveJH3721KxEbMQsWxg1HbMFPmi6s0HRraVPtrjqRNDUv74v7/r9GaIGrbp21de0sEsEY3hm6h+w55WhKqX7GLyLYbLa4U5Xu2WJQ3aoP+1zBkX/12cHTzcwcrSl8R2nM/JV108wcLrcyAEgVN93uJJ/pf3Qb9Pk/3eavNmnjmUllwB7GM7EvC004qQeHXZxURxxEMFpPVrsixp8O2iOikgTDiwGWjoLoaAGGAgYoQTtrBWzcyQL6peMhiwioW8Huxy14cAJnUIfTboL/GGJFUbNRHXK5ZX+cAYCHdakW67mCiOIkn9uvMkBAbfTyuZvBGFMvz7zxxkJGKrUP2WsVTFLCnfbSzk1xOURtoG/VM2AkLM/9nrVXUvr/8uLWyE+Lh5YBwQ27F9CtWr6y4misMG8yDbqeqgl/f3RYfwKZ0+1WfE5r5ycPtGGIiYFWi2kbNKvqh6r8HDjSzkdV+b68Toi+M0OOwKlg0EQ8OqvEpaLHDL0sWpYCxMN62ILJI+z1Alng2pqtmOnSnDrgNJS8LpBPHvaj7OSMRuRPV7DSdf5YiXNL/tLARzwBfq6fMEw12gPP7/nvWeUCMfL5fPrwOrlRU3WyQgtuO0CVQvedBsNlxpLUi/eU5VBr1cvy46gao3LBux2DNSDQPuHkaixoztmAXl+x1My1gI5t62kW6A8LVKq0+s7vCL3UrmwW23Be9bNKcYjInJphWRv800ZIlnQTFYg8rOD2/N7PY2xVVH8A3B92lTFyMRWyZzBiffGFUvMzbiLlewxeUPRdrhL7x61quooth2aTmxEWeAcUFsx/nnqV7qdjFRFAJkgGNIUfU7+GJBbyQigSA07C0PdTBjO36KBdsx7cp3HaYSFmr7QIcrqkVR+gOhsmPuYLMSeehNShjZXpRfDsbG+GlF1O1iojhmQDnYA8oMeh3JbQ72WpdE81X/Z82s2I7nYPoHTr7Rq16i3jaxUNNN/f4Gf1CKeq2JP/Z6FfES/XhFNRkYiQfjYxWq3zJUvdTuYqIw4qF4OPZBr1EbcW7UTU3yB0vFk2cbGInZP6L6pfoNkGblS3Yjpn4VLmIjPnLWPSOWc3hEae7eIX9MjbopM73n9ZmZ1WAOfDGt6Flg270XPlKgCpJcsXVRfeJoCLmFObGcwl/bPoMR23GWzCGcfCNUvWTB7x+zUMMNozZiiHlH1Xf7fTMCEkTdqr+5YikZEGF6cenIyGhfeZcFysE8sECxL/pBr6BNcr6emRlzLoJiXvBQey0jMfsxqt8CeiuUTpB+vATaa5bYiJv6vIr0SQeRwHdEaTvemz+r5VRqkomISIJnCtf53rFDAMyEeHzYpDtbompfbxXVSgEhV5F2f7SrhBHbcQJQbDumjnxR9ZK1CFaxcC/UdrqIjThdqfN9Pugv9YYkf2Q0BHDVFVVBMBEqMt9pTLJ1znMLUHrcCo1mKjsUQeR17UnwD36QVqrgsy/Dv+d0PSMRI7ZjKoUJjcr3GRZen90BabhjKKColxyJPO3/9XgPRfKdt+YXH4V4eymYBUIQ7s5fe869t8MOqWAmWKEUZjojWpbU98qojVjRNW/FM84yyeUbZqHFAKW7HVNFvqh6r8fDN1i4B/a1h2cjjhQN7vBtx8RG/N2qRUae03sRbsz5dZ2NOL++IAGA2ftsUGumGEA+ZIQtT/pShkcOqNIlFR/Y1XSCkYj9Farf6zn5Tk68zCwHOOANdTs9QbVmFsT/IUzb8QtVC2vBaskDs8DqCnx95hPF4/+82wYlIcFE/b8WyIN8Z1gPHNdvik7iQRXDgdjrqpb6Xd2MRO1Z2mzHNCnfOzAtZaEW97aP9IGKXSNtPrG63S9OObLtstsDD80vLgET4e7Z2w8KwsVLdUoAGR/ZoN5MsYBZUALW4NQPnDOZXd6muCoVcyH4P21iZc2HpTLHcPIdp3rJk3krCzXYORJscvlDam9GKbza7emb6gNbLy+vN7iN+ELYe0eWZrw06etzgxXKfAKMgHmQAYVDUz5wBl8sUFUkEIRGfGWhjoFmRmK2lSbbMS3K9z5MxbTXHJlZcKDDpU3XRlBactQVbJrof2dTkoZ/7sgrAxPhwcKfTufei3/XDsfNFBOk3zKI8048PnAotynYF52NOFL4P2sJARO+i1GOuZeT75eql6i3jSzUXJPTfyQgSnO0ut4bfd4J2/S6FdWqDPZRi8RTPcXJ/zXt63OrBaoHLdAD5kE8lLgvHh8gNuLf5mqWCckfnCue6D7CSMw20WI7pkH5EuKdQXuNhSRJauhxa2p39iLRfz7kv6BRn8xK7/5TVoZZbMSjeKzof3SF2VaFt+3QbabYQBJUQ9K4Qa+PHUditRFHrH7r2rMEkQnf8QxaxJ6u5Iuqt5Cm14CpcKTHWyuGIFfr677f78s633Z8zcpLiLIzj4049fOWrLiDYU+V6hegrN0CLSaiXwFKfF+q/YBdcr6ela15LsRQboAd2/G9qH4Lza58ySAb9TZivwj+5j6fLlvUBJHwkYBH13PdMzunuS850UR9vRI8W7g2YkfXu3YQwUyIgzLIcI4OegX/s6hWCkKOHtkINHaXQkD0MxCxBKBggF838kXVW4mH77HQtuu6XIdCoJ+Tas+gv9Qlge/qK6okMBGqst48mmjti9i95xFg7jErNJgpVlCITypXgm/ww1T99rGTIC2wu+UQIxH7HqrfSrMq3+3Aho14qGMooKs3nBD/Yzl5uyHONgfMAiEId+XfF/W6GR/a6R9HUBRWmAPNqbuRAHW1Wwdb+1myHetq6tKFfFH13oCHG1ho03vbR1RzCEWiKbxnB8kGkf1m4ZJv5b5YZxcgP9rviwB5e81lO+737J+xGUD3SV/xgZ3M2I6/hupXNx7SnHyReC3AyG7E/V6xq98j0jCz4Pf/+uZdf8Hjk+ZQca7AdTOfKo71NHtsMMdEtuMnkz7+nLSR3+udEbHPVS05R1jZcJPsdqyLCNXjondiqmShVva2uVR3CIUBH3y5ndLzmE4bnUX+vuDpegtAzHMxUQKmf2gO2/FpuW2A3FZ8er/S+z5t7mMkdpUyJxmbfFH1UjHKGA46RgJN7kBoCQVZeX57/cMto7/VOM4nYmMirnu4Mv23is3oaLRCmVeAYTA2NglLxwg327ej5Twi1g2Sy7ck1NbfxEj8iO1Y81lXWitfMqe3kPaaIJ1mtR1uGgYDByboaiCvlQeMyiIPFW5Q2r0X/44dToBxQdrCK+O7IOS2oyv8n58GRmzHuvgNNCNfVL1k/ygmbMSnnL7DAVGiYcWwJ1H1XjjIVuMI4c/1hqSRxBNni5LeV7yPvcMC1QMWwzrf1qPqvYDiUP32AwXjA1IgOEc8zozteCOqX01nyGipfAnxUr8K15iN2DOTgqycmfT1scaxA3++azQW2VJ0n1ruPeEtuyHXfHgXiXfHJP97Xm5D+qrfg+3ZjNiOCTdp2qWnCfmi6i0GRmzEh896a0MhfRxC47AJVa93iv+TbbENY7qwpe5qnhF3RLU+9kFiO7ZCExgHEkyxNTqqXy/QMD4ghnKQgFmyHRcbTfmSQbY42iPvF8HX4vTNoyArxE78ypSfqHGQUfx/MwqPPFX4w5DaV/kvu6FU77+h6p1uJgdpQwf1zmjwePc88Ad8DMRU03XFVSdfVL3UrSA/GWo7XYf1tBGfh4dR9YZDRv+Iycs6i1yR9ceGROvgXLWvg4Gac9QGR4B9eOW6nxKofkkbeoiCZ2tqYPeZw4zE9g5Uv5rsqKOF8iUWPuptxK6ANNg5HKigICvvIfF+ENYnaxyt+POXTNOIEIDv5P9Ys4GOj2yQBex31/wSVW9rOB9EAiZt6T3d1W9bf4U04h1koUWCRrZjVckXVS/Zifh6FlrznrYR0h+o94spIYVIZzI8jcnJKovclve/au0CaLYJqAiQu9vOtO24T67zSLCeggeOPbCrmZU+9+tR/X6dWfKVbcRM7Ebs9Iidg14qbMS/Q9UbWR9djYPM53yCSRqxjvivyt4+V+vL7rNCaUgAH7CJrah6I5rDi+qXtKnf6Z3xUdtx30gnI3FW3Xas5snvwlTOQpT3tbtoWLAmltHpX2FiZRPDc/hhwdZD2ADTdHi9SPvADoeBPTTLdR0NNgEF4wO+nU2sLA5VLnMYW+SLqjeRFTXWPhw45Q6ovhtxOPhnVL3RzcuscZAFrDcCS4jrHC5Pf0W3heGPW6DcK8AQY+S7EVVvVIuVo/qdfN64lg8+l39xqNV5ipF4P4HqN5E15Xs/pgLaI0s6weo63VYaej4wPRXjOf4D035WWOQnhY/ovQlo3Dt2OMkQ8e6X6zgWENeb7srTv/uMlZEhzwKZy9ggX1S9ZDR5AwuRPdk3aiMupiArxEYcmxe/xhHNYJ0+SGrsnp30Z9372IntuN8CrCx9eJGNOAr1S9qY7gtbSYFgsXisi5Vunw2oflXZOFcN5Utef9NpjyixER/t9dDgZGtR7HWwxvEh/nyH+ne5ovt6gY7ph2S3YxaWPnwHifdDhc71vNzm9FW/9R05jNiO00GlLj1FyRdVL9nmhgkb8aHuURsxDWs4EBuxkpsO/gRGdx6iE9lpnzRl2BuX0JKfQQGWtNFtO5bkOlUm/r4dpK3RYDue6a9tY8l2rPgWXkorX9KnRL2J0yeC73S/bz4FWSHLASq780CNg2xg+DKtPPITxw/pk5V2qk1Av0HVq/SmlFQsSxo8eXY++IIsTPmzgwqrxClGvqh6l5Fbn4XH2IExG3EKBVlZj6pXjVcvspcXdbbj5dmvHYm3jlC3CShKwZIGG5VTz7xyXSr79uHbQcf4gAQpgd3NrPT91qD6XUar8mXCUOHySwPddNiI30Hi3aFOM3G048+fURV4i1/6bt4DWbS2i7/YRrugaOuD/Bmq3nY1TowETMWypMH2wQpp2DsAbEBRjlOEfFH13oiHa1mI3p72kRagw0b8Ew0aCjWDSbfn/qrOKkAure1CBMj5nC7bcZ8GgoaGZUnt/l1NLYyQ77Wofm+khnxlG/E2FiLn9Ijtg16xioKsvIyq95CqV6hxkEVMtlAReNuQ7yvZ/1RKe/vYb4V5Ij224y2oelVdiAbVL1mS8mW9Cxpyuquk3uEORgh4m1K2YyVOcjemMhaitrfdRcNGiqr0402Cf8Gk+0j+2oKthy10LNU53etIKiW24ya57rQAFeMDvp3NrLgNy2TO05d8ZRvxFhYi1jYcOOkJhBZSkJWfo+pt0+RKY7bjn+pa2riOwSVp/17ByI0FJyxQ4RF033zyp9HaiKNQv6Qt/lz3B5/bv1A842TFcbhFCdtxrMr3AUz51CsaSYCDnW4apsCRfjytu2j+QES/XgV+pOgRGpbqjAT2d+y6LlK0T64zLfEMUDA+ENhz2o43KwttJF/mPn3IF1VvNjBiZz3p9NYHRKmIhicmql5tF5Qesx3rs5tBckNnQeJH1cAYOi1Q3WcBvZY+fDBWG3EU6pcS27FYJDZ21zPSTNaj+s3WS/mSvqI02iMUlKTQ0V5PHgVZ0bIfbzwBf4w/39b6sk8W3sfK8oEXAdWvHnl/G4n3Y52KTMWypP6DHXmSGAox0ETSIMaxm6jIF1UvWQB7LQs30aFubx0lNuKfKmwjjhRkapuo1cVy0z86lWY/vhgYxaAAi09bQculD0VQf/rhVOpX//GBUfkbmhk80FrHSDNZi+o36s0AolW+ZBsTBmzEIe/pft8CCrKiRz/eePVLNo58WaM7CB4q+AcrMI7/tmu2uzfBy6h69d7c81W5rer7tnqyZwH4gixsDGuHyLd0ip58UfVehofbWbh59rd7yLShZAqy8rBKNuJIQV6TPGpf5KqZrx6Ot44Us06+xHZ8yAaHNLiUB7SbfjiV+iVt9GEKQp8c+LyJFdvx7ah+L9NK+T7HQkRG/KH+s64ADYaKt5F4P6IiKDUOMpFdXduxxS/dmvvwLDAIPrWNuvLUfnASGzEVJgMkYNJW/6S7+u0YqpKGPKyMGUTFiRGRL6rem/BwJQvR2NPmOo0Hm87Z0LUfbxIQy2qPWif/27xf1loFMAz5YgXO3Kmu7bgX6FsXhYZlSW3+nU2nGWkmV6L6vUk18kXiJUTGhI24zyO2D/mosREfoSo4NQ7iJFLHGGMb9F2R9Yv5YDDUWWG+irbjx1H1UuXuQvVLXvlf1jsfoQFPldQz3M5IMyG244jEXiTKdxUmJkavUfXSYCOmoh9vEryASXE30Y8cjxEbcQoYDBKW6T11bMcn5bqgEZqMD0wH367mEUaayWKZI5UlX1S9ycCIjbh1KHDcF6TCRvwzVL10LhZS4wiA0vvsxbcPLEx9jRkbcaQ4ZYEKl/K24w2oegM0lhfVLxXLkkpu/wLxdN8JRpoJsR2HPcAfrvIlVro82ksu24gTKMgKjf144/E6pt2KsUjhwy3Alo04UtjfjlN077Pdch3QjGfltqwrAnvOxDNiO86DCGzH05Ivql4yeMKEjfh4n7c+GJIKKcjK46h66V6lacx2rMy0ouTDHfmJn1SBwdEjQFWfRbHFzR/W2kYchfpVb3wgElEVFAvFhi6WbMdhDTiHo3xJ3w/1/XhiCMRjfR4aFvmhuR9vPAF/gj/fivU0Txf+iJXlAGPG23ZQYjzhLSTeTxgpMmnLp/TOhP9QZ74UDIkMxCsFwhzrsUyjeufhYQ0LLeRQt5vYiLMpyMoGVL0BYAdkN4OoG3VJxo6TKfamhWASDAuwsMUa02ClKMecCci24w26Z0QKZQcPnDnISNjWoPqdF6vyJdY5G+0l9QYlT8uAfxEFWWGhH2+8+j2KP1+K6ruCCOsK1hi5n3dCvGePqW/716h6jzJW5NdAx2VJv0DwVO9C8Pg9DMTLBmHYji1TqN7leLiNhZaxv8PVgIckCrJCi404UjyGyRXpl67N/vf6BIuvCEwGlIJF9TaIpg+SxPhR1sor244fpCArSf7dLQ2MhO02VL/Lo1W+21ko4ZA/1NfjCtIw2PMWEu8nwCJqHGTt2simFVm8oVtyN+SBSfGJbXRB7Ui7a4iNuJPF8iIBKzI+ECvEzlHbcR8jYdseMfmi6r0ZDytZKN2+NhfZBkXvFbTITbge2AaZVnQ23A/fkf+LOkGgYqlOXYBSMHunHSLpgzwL9E8/nA4xjQ8oBKt/Z1MbI/Faier35rDJlyUbca9bbBvyiZUUZOUlVL2NTN9WNQ7iJApvWpFtwLs88/kFYHLUWmFBUAh780myG/EIy+VF9Uv6qn+jdz5CA55K6ewQKwQ8qe14IuW7GhMTN9be9hEXBdkgeXjMIHxCphVN6ya6z7GZlqU69UZymLbjE8DK9MPpQaZRufXOhG9Xs5uReC2QOXVq8kXVm8IKkZwZChzzBSUaHhLERtxpiNuqxhGE6aYVxZ/pn5/6huENFeGiyQJVLmHaLYeIjThohPKi+o18fEAFSJ7A/FBz73FGwvYYqt+U6ZQvGdHMpb0kxEZc3+mmQXkZoR9vPP6Iaddk/9xU9CANS3XSBNvbcXBmiv9/JsfUSFB1WdJw4d/XmsSI7TgXJpgtYjlP9ZIPPMxCSY71eg4GQ1IBBVkhuxGPGOq2GrMdTzx4mFzXlpPwOVe949AjQGWPBSbrg6TeRhyF+iUuv8d1F2FBsSB4pJMV48XDqH5zJ1O+ZP4h9f14xEZ8vNdLA/GSV54XwIiocezEn2+M//NTRetGgGNC/Mk+4WDaG0i8Ow1a5LDGB9RG4HBXASO242QYN8fbIqte0nd6Dws1XkdsxABZFGSF2IiDYFyQvt9zjXp+xnvHU22tprERR4oRARY2WeH8PkgRaLDlqqd+g0CH7TgruP80K7sd34Pqd8F45UuscNTvNusNSu5WOmzEu5B4/whGRo3jGP58cfR3QYQ1BasTgGNKvG+H82P0IqreYwYvMrkHPtM7E8GmvsXg8bMw+8EK59mOLah6iZniFhZqen+Hi8wzpMFGvB7MAdKv57ph5u/q4yxQCBxTvwIDFNaN2Y5dQEGfqAbqV6LkXkj0f9bMyjz7W1D9rvxC+TIxWj/sC/VSYiN+A1XvTjADahxdYOv/2U05m2Zzag0PO20wOyiM2oi7zFBeJOBP8fCm3vkQu4crpUFmbMejnPv/BRgAleAPExQpUr0AAAAASUVORK5CYII=";
var totalWidth;
var totalHeight;

let descargasPendientes = 0;

const colecciones = [
  { nombre: "Paleontológico", color: "#00acef" },
  { nombre: "Arqueológico", color: "#a9d42c" },
  { nombre: "Virreinato", color: "#ef9c2c" },
  { nombre: "Arte moderno y contemporaneo", color: "#D65193" },
  { nombre: "Culturas populares", color: "#663286" },
  { nombre: "Numismática", color: "#d66176" },
  { nombre: "Historia natural", color: "#f4cc21" },
  { nombre: "Objeto histórico", color: "#ac5798" },
  { nombre: "Arte del siglo XIX", color: "#ec0743" },
  { nombre: "En Desarrollo", color: "#ec0743" },
];
var generalMargin = 15;
 
function descargarReportePDF(ficha) {
  $.get(
    "https://patrimoniocultural.edomex.gob.mx/fichaToJSON.php?ficha=" + ficha,
    function (data) {
      data.trim();
      if (data == "NOT_FOUND") {
        displayNotification(
          "ALERT",
          "Esa ficha no fue encontrada en el sistema."
        );
      } else if (data == "REQUEST_INCOMPLETE") {
        displayNotification(
          "ERROR",
          "No está especificada la ficha que buscas."
        );
      } else {
        construirReportePDF(procesarBloquesDeDatos(JSON.parse(data)));
      }
    }
  );
}

function procesarBloquesDeDatos(data) {
  let header = {},
    sidebar = {},
    body = [];
  header["usuarioDeRegistro"] = data["usuario"];
  header["museo"] = data["museo"];
  header["archivos"] = data["archivos"];
  header["ficha"] = data["id"];
  header["fecha"] = extraerFecha(data["id"]);
  header["estado"] = data["status"];
  header["coleccion"] = parseInt(data["id_coleccion"]);
  sidebar["archivos"] = data["archivos"];
  let secciones = data["secciones"];
  for (let key in secciones) {
    let seccion = secciones[key];
    if (
      seccion["nombreSeccion"].includes("Dimensiones") ||
      seccion["nombreSeccion"].includes("Medidas") ||
      seccion["nombreSeccion"].includes("Procedencia")
    ) {
      sidebar[seccion["nombreSeccion"].toLowerCase()] = seccion;
    } else {
      body.push(seccion);
    }
    if (
      seccion["nombreSeccion"] == "Identificación general" ||
      seccion["nombreSeccion"] == "Datos de identificación general"
    ) {
      let indexToRemove = -1;
      for (let i = 0; i < seccion["campos"].length; i++) {
        let campo = seccion["campos"][i];
        if (campo["idCampo"] == "8") {
          header["ubicacion"] = campo["valor"];
          indexToRemove = i;
          break;
        }
      }
      delete seccion["campos"][indexToRemove];
    }
  }
  return { header: header, sidebar: sidebar, body: body };
}

function extraerFecha(id) {
  let dateInMicros = id.substring(5);
  let date = new Date(parseInt(dateInMicros) * 1000);
  return (
    date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear()
  );
}

function completarPDF() {
  if (descargasPendientes == 0) {
    finalPDF.save(finalName);
    $(".loader-container").css("display", "none");
  } else {
    console.log("not ready :(");
    setTimeout(completarPDF, 1000);
  }
}

function esperarParaTerminar() {
  if (descargasPendientes == 0) {
    let pendiente = construirRestante(
      finalPDF,
      cuerpoCompleto,
      sobranteDeCuerpo
    );
    while (pendiente != null) {
      sobranteDeCuerpo = pendiente;
      pendiente = construirRestante(finalPDF, cuerpoCompleto, sobranteDeCuerpo);
    }

    finalPDF.save(finalName);
    $(".loader-container").css("display", "none");
  } else {
    console.log("not ready :(");
    setTimeout(esperarParaTerminar, 1000);
  }
}

function esperarDescargas() {
  if (descargasPendientes == 0) {
    return 1;
  } else {
    console.log("not ready :(");
    setTimeout(esperarDescargas, 2000);
  }
}

let finalPDF = null;
let finalName = "";
let sobranteDeCuerpo;
let cuerpoCompleto;

function construirReportePDF(blocks) {
  $(".loader-container").css("display", "flex");
  var pdf = new jsPDF("p", "mm", "letter");
  totalWidth = pdf.internal.pageSize.getWidth();
  totalHeight = pdf.internal.pageSize.getHeight();
  let coleccionID = blocks["header"]["coleccion"];
  adjuntarBarraDistintiva(pdf, colecciones[coleccionID - 1]);
  adjuntarCabecera(pdf, blocks["header"]);

  adjuntarLateral(pdf, blocks["sidebar"]);
  esperarDescargas();

  let restante = printRightContent(pdf, blocks["body"]);
  finalPDF = pdf;
  let nombreDeArchivo = "reporte_" + blocks["header"]["ficha"];
  finalName = nombreDeArchivo.replace(".", "-") + ".pdf";
  if (restante != null) {
    cuerpoCompleto = blocks["body"];
    sobranteDeCuerpo = restante;
    esperarParaTerminar();
    //construirRestante(pdf, blocks["body"],restante);
  } else {
    completarPDF();
  }
  //alert("El reporte de la ficha ha sido generado.");
  //
  //pdf.save(nombreDeArchivo.replace(".", "-") + ".pdf");
}

function adjuntarBarraDistintiva(pdf, coleccion) {
  pdf.setFillColor(coleccion.color).rect(0, 0, totalWidth, 5, "F");
  pdf.setFillColor("#EEEEEE").rect(0, 5, totalWidth, 16, "F");
  pdf.addImage(patrimonio_icono, "JPEG", 15, 7, 18, 11);
  pdf.setFontSize(12).text(34, 12, "Patrimonio").text(34, 17, "Cultural");
  pdf
    .setFontSize(13)
    .text(120, 11, "Colección")
    .setFontSize(15)
    .text(120, 18, coleccion.nombre);
}

function adjuntarCabecera(pdf, campos) {
  console.log(campos["archivos"]);

  if (campos["archivos"] != null && campos["archivos"].length > 0) {
    let archivo = campos["archivos"][0];
    let urlThumbnail = "";
    if (
      archivo.endsWith("jpg") ||
      archivo.endsWith("jpeg") ||
      archivo.endsWith("png")
    )
      urlThumbnail = "https://patrimoniocultural.edomex.gob.mx/" + archivo;
    else if (archivo.endsWith("pdf"))
      urlThumbnail =
        "https://patrimoniocultural.edomex.gob.mx/images/thumbs_PDF.jpg";
    else if (
      archivo.endsWith("mp4") ||
      archivo.endsWith("avi") ||
      archivo.endsWith("3gp")
    )
      urlThumbnail =
        "https://patrimoniocultural.edomex.gob.mx/images/video_icon.png";
    if (urlThumbnail != "") {
      console.log("downloading ", urlThumbnail);
      requestFile(urlThumbnail, insertarImagen, pdf);
    }
  }

  let columna = 65;
  let tamano = 65;
  let campo = campos["museo"];
  pdf
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(columna, 32, "Museo")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(columna, 36, textoEnTamano(pdf, campo, tamano));
  campo = campos["ubicacion"];
  pdf
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(columna, 45, "Ubicación actual")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(columna, 49, textoEnTamano(pdf, campo, tamano));
  campo = campos["ficha"];
  pdf
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(columna, 58, "ID del registro")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(columna, 62, textoEnTamano(pdf, campo, tamano));
  columna += 75;
  campo = campos["estado"];
  pdf.setFillColor("#B1D939").rect(columna, 33, 20, 4, "F");
  pdf
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(columna, 32, "Status")
    .setFontStyle("bold")
    .setTextColor("white")
    .text(columna + 2, 36, textoEnTamano(pdf, campo, tamano));
  campo = campos["fecha"];
  pdf
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(columna, 45, "Fecha de creación")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(columna, 49, textoEnTamano(pdf, campo, tamano));
  campo = campos["usuarioDeRegistro"];
  pdf
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(columna, 58, "Usuario de registro")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(columna, 62, textoEnTamano(pdf, campo, tamano));
  pdf.setDrawColor("#E7E7E8").line(6, 68, 209, 68, "S");
}

function adjuntarLateral(pdf, secciones) {
  let archivos = secciones["archivos"];
  let procedencia = secciones["procedencia"];
  let medidas = secciones["dimensiones"];
  let medidasBase = secciones["medidas máximas base/marco"];
  printLeftContent(pdf, archivos, procedencia, medidas, medidasBase);
}

function construirRestante(pdf, secciones, estadoAnterior) {
  pdf.addPage();
  let x = 15;
  let y = 15;

  if (estadoAnterior["campo"] != 0) {
    let seccion = secciones[estadoAnterior["seccion"]];
    let campos = seccion.campos;
    for (let i = estadoAnterior["campo"]; i < campos.length; i++) {
      let campo = campos[i];
      if (
        totalHeight - (y + 4 * textoEnTamano(pdf, campo.valor, 170).length) <
        12
      ) {
        return { seccion: estadoAnterior["seccion"], campo: i };
      }
      pdf
        .setFontSize(9)
        .setFontStyle("normal")
        .setTextColor("#000000")
        .text(x, y, campo.nombre);
      y += 4;

      if (pdf.getTextWidth(campo.valor) > 100) {
        let parrafo = textoEnTamano(pdf, campo.valor, 170);
        pdf.setFontStyle("normal").setTextColor("#777777").text(x, y, parrafo);
        y += 4 * parrafo.length - 4;
      } else {
        pdf
          .setFontStyle("normal")
          .setTextColor("#777777")
          .text(x, y, campo.valor);
        if (campos[i + 1] != null) {
          campo = campos[i + 1];
          valor = campo.valor;
          if (pdf.getTextWidth(valor) < 100) {
            i += 1;
            y -= 12;
            x += 100;
            y += 8;
            pdf
              .setFontSize(9)
              .setFontStyle("normal")
              .setTextColor("#000000")
              .text(x, y, campo.nombre);
            y += 4;
            pdf
              .setFontStyle("normal")
              .setTextColor("#777777")
              .text(x, y, campo.valor);
            x -= 100;
          }
        }
      }
      y += 8;
    }
    if (estadoAnterior["seccion"] < secciones.length - 1) {
      pdf.setDrawColor("#E7E7E8").line(x, y, 209, y, "S");
    }
    y += 7;
    estadoAnterior["seccion"]++;
  }

  for (let i = estadoAnterior["seccion"]; i < secciones.length; i++) {
    if (totalHeight - y < 14) {
      return { seccion: i, campo: 0 };
    }

    var seccion = secciones[i];
    pdf
      .setFontSize(12)
      .setFontStyle("bold")
      .setTextColor("#000000")
      .text(x, y, seccion.nombreSeccion);
    var campos = seccion.campos;

    let doc = pdf;
    for (var j = 0; j < campos.length; j++) {
      if (campos[j]) {
        campo = campos[j];
        let valor = campo.valor;
        if (
          totalHeight - (y + 8 + 4 * textoEnTamano(doc, valor, 120).length) <
          12
        ) {
          return { seccion: i, campo: j };
        }
        y += 8;
        doc
          .setFontSize(9)
          .setFontStyle("normal")
          .setTextColor("#000000")
          .text(x, y, campo.nombre);
        y += 4;
        if (doc.getTextWidth(valor) > 90) {
          let parrafo = textoEnTamano(doc, valor, 170);
          doc
            .setFontStyle("normal")
            .setTextColor("#777777")
            .text(x, y, parrafo);
          y += 4 * parrafo.length - 4;
        } else {
          doc
            .setFontStyle("normal")
            .setTextColor("#777777")
            .text(x, y, campo.valor);
          if (campos[j + 1] != null) {
            campo = campos[j + 1];
            valor = campo.valor;
            if (doc.getTextWidth(valor) < 90) {
              j += 1;
              y -= 12;
              x += 100;
              y += 8;
              doc
                .setFontSize(9)
                .setFontStyle("normal")
                .setTextColor("#000000")
                .text(x, y, campo.nombre);
              y += 4;
              doc
                .setFontStyle("normal")
                .setTextColor("#777777")
                .text(x, y, campo.valor);
              x -= 100;
            }
          }
        }
      }
    }
    y += 7;
    if (i < secciones.length - 1) {
      doc.setDrawColor("#E7E7E8").line(x, y, 209, y, "S");
    }
    y += 7;
  }

  return null;
}

function textoEnTamano(pdf, text, size) {
  return pdf.splitTextToSize(text, size);
}

function generarDetallePDF(idDeFicha) {
  $.get(
    'https://patrimoniocultural.edomex.gob.mx/fichasToJSON.php?fichas=["' +
      idDeFicha +
      '"]',
    function (data) {
      var doc = new jsPDF("p", "mm", "letter");
      totalWidth = doc.internal.pageSize.getWidth();
      totalHeight = doc.internal.pageSize.getHeight();
      var fichas = JSON.parse(data);
      var ficha = fichas[0];

      addHeader(doc, ficha.ficha);

      addIntro(
        doc,
        ficha.archivos,
        ficha.museo,
        ficha.id,
        ficha.usuario,
        ficha.status
      );
      var seccionProcedencia = obtenerSeccionPorNombre(
        ficha.secciones,
        "Procedencia"
      );
      var seccionMedidasMaximas = obtenerSeccionPorNombre(
        ficha.secciones,
        "Dimensiones"
      );
      var seccionMedidasBM = obtenerSeccionPorNombre(
        ficha.secciones,
        "Medidas máximas Base/Marco"
      );
      printLeftContent(
        doc,
        ficha.archivos,
        seccionProcedencia,
        seccionMedidasMaximas,
        seccionMedidasBM
      );
      printRightContent(doc, ficha.secciones);
      alert("La ficha fue exportada exitosamente");
      doc.save("test.pdf");
    }
  );
}

function addHeader(doc, coleccion) {
  var colorDeFicha = hexc($(".franja").first().css("backgroundColor"));
  //alert(colorDeFicha);
  doc.setFillColor(colorDeFicha).rect(0, 0, totalWidth, 5, "F");
  doc.setFillColor("#EEEEEE").rect(0, 5, totalWidth, 16, "F");
  doc.addImage(patrimonio_icono, "JPEG", 15, 7, 18, 11);
  doc.setFontSize(12).text(34, 12, "Patrimonio").text(34, 17, "Cultural");
  doc
    .setFontSize(13)
    .text(120, 11, "Colección")
    .setFontSize(16)
    .text(120, 18, coleccion);
}

function hexc(colorval) {
  var parts = colorval.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
  delete parts[0];
  for (var i = 1; i <= 3; ++i) {
    parts[i] = parseInt(parts[i]).toString(16);
    if (parts[i].length == 1) parts[i] = "0" + parts[i];
  }
  return "#" + parts.join("");
}

function addIntro(doc, archivos, museo, id, usuario, status) {
  if (archivos != null && archivos.length > 0) {
    var imageData;
    if (
      archivos[0].endsWith("jpg") ||
      archivos[0].endsWith("jpeg") ||
      archivos[0].endsWith("png")
    )
      requestFile(
        "https://patrimoniocultural.edomex.gob.mx/" + archivos[0],
        insertarImagen,
        doc
      );
    else if (archivos[0].endsWith("pdf"))
      requestFile(
        "https://patrimoniocultural.edomex.gob.mx/images/thumbs_PDF.jpg",
        insertarImagen,
        doc
      );
    else if (
      archivos[0].endsWith("mp4") ||
      archivos[0].endsWith("avi") ||
      archivos[0].endsWith("3gp")
    )
      requestFile(
        "https://patrimoniocultural.edomex.gob.mx/images/video_icon.png",
        insertarImagen,
        doc
      );

    //doc.addImage(imageData, 'JPEG', 15, 40, 180, 160);
  }
  doc
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(65, 32, "Museo")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(65, 37, museo);
  doc
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(65, 44, "Ubicación del Museo")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(65, 49, "Pendiente");
  doc
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(65, 56, "ID del registro")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(65, 61, id);
  doc.setFillColor("#B1D939").rect(145, 33, 20, 6, "F");
  doc
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(145, 32, "Status")
    .setFontStyle("bold")
    .setTextColor("white")
    .text(147, 37, status);
  doc
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(145, 44, "Fecha de creación")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(145, 49, idToFecha(id));
  doc
    .setFontSize(9)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(145, 56, "Usuario de registro")
    .setFontStyle("normal")
    .setTextColor("#777777")
    .text(145, 61, usuario);
  doc.setDrawColor("#E7E7E8").line(6, 66, 209, 66, "S");
}

function insertarImagen(imageData, doc) {
  console.log("adding", imageData);
  doc.addImage(imageData, "JPEG", 20, 30, 25, 25);
  descargasPendientes--;
}

function requestFile(url, callback, doc) {
  descargasPendientes++;
  console.log("descargando: ", url);
  var xhr = new XMLHttpRequest();
  xhr.onload = function () {
    var reader = new FileReader();
    reader.onloadend = function () {
      callback(reader.result, doc);
    };
    reader.readAsDataURL(xhr.response);
  };
  xhr.open("GET", url);
  xhr.responseType = "blob";
  xhr.send();
}

function requestFile(url, callback, doc, indice) {
  descargasPendientes++;
  var xhr = new XMLHttpRequest();
  xhr.onload = function () {
    var reader = new FileReader();
    reader.onloadend = function () {
      callback(reader.result, doc, indice);
    };
    reader.readAsDataURL(xhr.response);
  };
  xhr.open("GET", url);
  xhr.responseType = "blob";
  xhr.send();
}

function populateMultimediaSection(imageData, doc, index) {
  var xLevel = 9;
  var yLevel = 83;
  doc.addImage(imageData, "JPEG", xLevel + xLevel * index, yLevel, 8, 9);
  descargasPendientes--;
}

function printLeftContent(doc, archivos, procedencia, medidas, medidasBase) {
  var startX = 6;
  var startY = 76;
  doc
    .setFontSize(12)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(startX, startY, "Galería");
  doc.setDrawColor("#E7E7E8").rect(6, 80, 60, 15, "S");

  if (archivos != null)
    for (var i = 0; i < archivos.length; i++) {
      requestFile(
        "https://patrimoniocultural.edomex.gob.mx/" + archivos[i],
        populateMultimediaSection,
        doc,
        i
      );
    }

  startX = 6;
  startY = 105;
  doc
    .setFontSize(11)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(startX, startY, "Procedencia");
  startY += 5;
  var contentHeight = 0;
  if (procedencia != null) {
    var campos = procedencia.campos;
    if (campos.length == 0) {
      contentHeight = 10;
    } else
      for (var i = 0; i < campos.length; i++) {
        contentHeight += 4;
        doc
          .setFontSize(9)
          .setFontStyle("bold")
          .setTextColor("#000000")
          .text(10, startY + contentHeight, campos[i].nombre);
        contentHeight += 4;
        var currentVal =
          campos[i].valorReal != null ? campos[i].valorReal : campos[i].valor;
        doc
          .setFontStyle("normal")
          .setTextColor("#777777")
          .text(10, startY + contentHeight, currentVal);
        contentHeight += 1;
      }
  } else {
    contentHeight = 10;
  }
  doc.setDrawColor("#E7E7E8").rect(startX, startY, 60, contentHeight + 2, "S");

  startY += contentHeight + 10;
  doc
    .setFontSize(11)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(startX, startY, "Medidas");
  startY += 5;
  var contentHeight = 0;
  if (medidas != null) {
    var campos = medidas.campos;
    if (campos.length == 0) {
      contentHeight = 10;
    } else
      for (var i = 0; i < campos.length; i++) {
        contentHeight += 4;
        doc
          .setFontSize(9)
          .setFontStyle("bold")
          .setTextColor("#000000")
          .text(10, startY + contentHeight, campos[i].nombre);
        contentHeight += 4;
        if (campos[i].tipo == "catalogo") campos[i].valor = campos[i].valorReal;
        doc
          .setFontStyle("normal")
          .setTextColor("#777777")
          .text(10, startY + contentHeight, campos[i].valor);
        contentHeight += 1;
      }
  } else {
    contentHeight = 10;
  }
  doc.setDrawColor("#E7E7E8").rect(startX, startY, 60, contentHeight + 2, "S");

  startY += contentHeight + 10;
  doc
    .setFontSize(11)
    .setFontStyle("bold")
    .setTextColor("#000000")
    .text(startX, startY, "Medidas Base/Marco");
  startY += 5;
  var contentHeight = 0;
  if (medidasBase != null) {
    var campos = medidasBase.campos;
    if (campos.length == 0) {
      contentHeight = 10;
    } else
      for (var i = 0; i < campos.length; i++) {
        contentHeight += 4;
        doc
          .setFontSize(9)
          .setFontStyle("bold")
          .setTextColor("#000000")
          .text(10, startY + contentHeight, campos[i].nombre);
        contentHeight += 4;
        //if (campos[i].tipo == "catalogo")
        //    campos[i].valor = campos[i].valorReal;
        doc
          .setFontStyle("normal")
          .setTextColor("#777777")
          .text(10, startY + contentHeight, campos[i].valor);
        contentHeight += 1;
      }
  } else {
    contentHeight = 10;
  }
  doc.setDrawColor("#E7E7E8").rect(startX, startY, 60, contentHeight + 2, "S");
}

function printRightContent(doc, secciones) {
  var startX = 80;
  var startY = 76;
  let maxWidth = 45;

  for (var i = 0; i < secciones.length; i++) {
    if (totalHeight - startY < 24) {
      return { seccion: i, campo: 0 };
    }

    var seccion = secciones[i];
    doc
      .setFontSize(12)
      .setFontStyle("bold")
      .setTextColor("#000000")
      .text(startX, startY, seccion.nombreSeccion);
    var campos = seccion.campos;
    let campo = null;
    for (var j = 0; j < campos.length; j++) {
      if (campos[j]) {
        campo = campos[j];
        let valor = campo.valor;
        if (
          totalHeight -
            (startY + 8 + 4 * textoEnTamano(doc, valor, 120).length) <
          12
        ) {
          return { seccion: i, campo: j };
        }
        startY += 8;
        doc
          .setFontSize(9)
          .setFontStyle("normal")
          .setTextColor("#000000")
          .text(startX, startY, campo.nombre);
        startY += 4;
        if (doc.getTextWidth(valor) > 70) {
          let parrafo = textoEnTamano(doc, valor, 120);
          doc
            .setFontStyle("normal")
            .setTextColor("#777777")
            .text(startX, startY, parrafo);
          startY += 4 * parrafo.length - 4;
        } else {
          doc
            .setFontStyle("normal")
            .setTextColor("#777777")
            .text(startX, startY, campo.valor);
          if (campos[j + 1] != null) {
            campo = campos[j + 1];
            valor = campo.valor;
            if (doc.getTextWidth(valor) < 70) {
              j += 1;
              startY -= 12;
              startX += 70;
              startY += 8;
              doc
                .setFontSize(9)
                .setFontStyle("normal")
                .setTextColor("#000000")
                .text(startX, startY, campo.nombre);
              startY += 4;
              doc
                .setFontStyle("normal")
                .setTextColor("#777777")
                .text(startX, startY, campo.valor);
              startX -= 70;
            }
          }
        }
      }
    }
    startY += 7;
    if (i < secciones.length - 1) {
      doc.setDrawColor("#E7E7E8").line(startX, startY, 209, startY, "S");
    }
    startY += 7;
  }

  return null;
}

function obtenerSeccionPorNombre(secciones, nombre) {
  var seccion = null;
  for (var i = 0; i < secciones.length; i++) {
    console.log("=> evaluando '" + nombre + "'", secciones[i].nombreSeccion);
    if (secciones[i].nombreSeccion == nombre) {
      seccion = secciones[i];
      secciones.splice(i, 1);
      break;
    }
  }
  console.log("return: ", seccion);
  return seccion;
}

function idToFecha(id) {
  var millis = id.split("-")[1];
  var date = new Date(parseInt(millis) * 1000);
  var stringDate =
    date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear();
  return stringDate;
}
